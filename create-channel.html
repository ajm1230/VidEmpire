<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create Channel</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js"></script>
  <script src="firebase-config.js"></script> <!-- Your Firebase config here -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">

  <!-- Buttons Section -->
  <div id="buttonContainer" class="mb-6">
    <button id="loginBtn" class="bg-blue-600 text-white font-bold px-4 py-2 rounded hidden">
      Login / Sign Up
    </button>
    <button id="openFormBtn" class="bg-blue-600 text-white font-bold px-4 py-2 rounded hidden">
      + Create New Channel
    </button>
  </div>

  <!-- Channel Form -->
  <form id="channelForm" class="hidden bg-white shadow-md rounded p-6 w-full max-w-md space-y-4">
    <h2 class="text-xl font-semibold mb-4">Create Your Channel</h2>

    <!-- Profile Image -->
    <div>
      <label class="block font-medium">Channel Profile Image</label>
      <input type="file" id="channelImage" accept="image/*" class="mt-1" />
      <img id="previewImage" src="" alt="Preview" class="mt-2 w-20 h-20 object-cover rounded-full hidden" />
    </div>

    <div>
      <label>Email</label>
      <input type="email" id="email" class="w-full border px-3 py-2 rounded bg-gray-100" readonly />
    </div>

    <div>
      <label>User ID</label>
      <input type="text" id="uid" class="w-full border px-3 py-2 rounded bg-gray-100" readonly />
    </div>

    <div>
      <label>Channel Name</label>
      <input type="text" id="channelName" placeholder="Enter your channel name"
             class="w-full border px-3 py-2 rounded" />
    </div>

    <div>
      <label>Channel ID</label>
      <input type="text" id="channelId" class="w-full border px-3 py-2 rounded" />
      <p id="channelIdStatus" class="text-sm mt-1"></p>
      <div id="suggestions" class="text-sm text-gray-500"></div>
    </div>

    <button type="submit"
      class="w-full bg-green-600 text-white font-bold py-2 rounded hover:bg-green-700">
      Submit
    </button>
  </form>

  <script>
    window.onload = function () {
      const loginBtn = document.getElementById("loginBtn");
      const openFormBtn = document.getElementById("openFormBtn");
      const channelForm = document.getElementById("channelForm");
      const emailInput = document.getElementById("email");
      const uidInput = document.getElementById("uid");
      const channelNameInput = document.getElementById("channelName");
      const channelIdInput = document.getElementById("channelId");
      const channelIdStatus = document.getElementById("channelIdStatus");
      const suggestionsBox = document.getElementById("suggestions");
      const previewImage = document.getElementById("previewImage");

      firebase.auth().onAuthStateChanged(async (user) => {
        if (!user) {
          loginBtn.classList.remove("hidden");
          loginBtn.onclick = () => location.href = "login.html";
          return;
        }

        openFormBtn.classList.remove("hidden");

        // Pre-fill form fields
        emailInput.value = user.email;
        uidInput.value = user.uid;

        // If user already has a channel, show existing info (optional enhancement)
        const snapshot = await firebase.database().ref("channels").orderByChild("uid").equalTo(user.uid).once("value");
        if (snapshot.exists()) {
          openFormBtn.classList.add("hidden");
          const channelData = Object.values(snapshot.val())[0];
          alert(`You already created channel "${channelData.name}" on ${new Date(channelData.createdAt).toLocaleString()}`);
          return;
        }
      });

      openFormBtn.addEventListener("click", () => {
        openFormBtn.classList.add("hidden");
        channelForm.classList.remove("hidden");
      });

      // Live preview image
      document.getElementById("channelImage").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = () => {
            previewImage.src = reader.result;
            previewImage.classList.remove("hidden");
          };
          reader.readAsDataURL(file);
        }
      });

      // Auto generate channel ID
      channelNameInput.addEventListener("input", () => {
        const name = channelNameInput.value.trim().toLowerCase().replace(/\s+/g, '-');
        if (!channelIdInput.value) {
          channelIdInput.value = name;
        }
      });

      // Channel ID uniqueness check
      channelIdInput.addEventListener("input", async () => {
        const id = channelIdInput.value.trim();
        const snap = await firebase.database().ref("channels/" + id).get();
        if (snap.exists()) {
          channelIdStatus.textContent = "Channel ID already used.";
          channelIdStatus.className = "text-red-600";
          suggestionsBox.innerHTML = "";
          for (let i = 1; i <= 3; i++) {
            const suggestion = id + i;
            const exists = await firebase.database().ref("channels/" + suggestion).get();
            if (!exists.exists()) {
              suggestionsBox.innerHTML += `<div>Try: <b>${suggestion}</b></div>`;
            }
          }
        } else {
          channelIdStatus.textContent = "Channel ID available.";
          channelIdStatus.className = "text-green-600";
          suggestionsBox.innerHTML = "";
        }
      });

      // Submit handler
      channelForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const user = firebase.auth().currentUser;
        if (!user) return alert("Not signed in.");

        const id = channelIdInput.value.trim();
        const name = channelNameInput.value.trim();
        const file = document.getElementById("channelImage").files[0];

        const snap = await firebase.database().ref("channels/" + id).get();
        if (snap.exists()) return alert("Channel ID already exists.");

        if (!confirm("Create channel?")) return;

        let imageUrl = "";
        if (file) {
          const ref = firebase.storage().ref("channelImages/" + id + ".jpg");
          await ref.put(file);
          imageUrl = await ref.getDownloadURL();
        }

        const data = {
          uid: user.uid,
          email: user.email,
          name,
          id,
          imageUrl,
          createdAt: Date.now()
        };

        await firebase.database().ref("channels/" + id).set(data);
        alert("Channel created!");
        location.reload();
      });
    };
  </script>
</body>
</html>
