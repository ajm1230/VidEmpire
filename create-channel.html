<!DOCTYPE html><html lang="en" class="bg-gray-50">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Create Channel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="firebase-config.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
  <div class="max-w-lg w-full space-y-6">
    <!-- Channel Details Container -->
    <div id="channelDetails" class="hidden bg-white shadow-md p-6 rounded space-y-4 text-center">
      <img id="existingProfile" class="mx-auto w-24 h-24 rounded-full object-cover" alt="Channel Profile" />
      <h2 id="existingChannelName" class="text-2xl font-bold"></h2>
      <p id="existingChannelId" class="text-blue-600 font-mono"></p>
      <p id="existingEmail" class="text-gray-600"></p>
      <p id="existingCreatedAt" class="text-gray-500 italic text-sm"></p>
      <div class="flex justify-center gap-4 mt-4">
        <button id="editBtn" class="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded font-semibold text-white">Edit</button>
        <button id="deleteBtn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded font-semibold text-white">Delete</button>
      </div>
    </div><!-- Create Button -->
<button id="openFormBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold px-6 py-3 rounded flex items-center justify-center gap-2 w-full max-w-xs mx-auto">
  <span class="text-xl font-bold">+</span> Create New Channel
</button>

<!-- Create/Edit Form -->
<form id="channelForm" class="hidden bg-white p-6 rounded shadow-md space-y-5" novalidate>
  <div>
    <label class="block mb-1 font-semibold">Profile Image</label>
    <input type="file" id="profileImage" accept="image/*" class="w-full border rounded p-2" />
    <img id="previewImage" class="hidden w-24 h-24 rounded-full mt-2 object-cover mx-auto" alt="Preview" />
  </div>
  <div>
    <label class="block mb-1 font-semibold">Channel Name</label>
    <input type="text" id="channelName" placeholder="Enter Your Channel Name" class="w-full border rounded p-2" required />
    <p id="nameError" class="text-red-600 text-sm mt-1 hidden">Invalid name</p>
  </div>
  <div>
    <label class="block mb-1 font-semibold">Channel ID</label>
    <input type="text" id="channelId" class="w-full border rounded p-2 font-mono" required />
    <p id="idStatus" class="text-red-600 text-sm mt-1 hidden">Channel ID in use</p>
    <div id="idSuggestions" class="text-gray-500 text-sm mt-1"></div>
  </div>
  <div>
    <label class="block mb-1 font-semibold">Email</label>
    <input type="email" id="userEmail" readonly class="w-full bg-gray-100 border rounded p-2" />
  </div>
  <div>
    <label class="block mb-1 font-semibold">User ID</label>
    <input type="text" id="userId" readonly class="w-full bg-gray-100 border rounded p-2 font-mono" />
  </div>
  <button type="submit" id="submitBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold w-full py-3 rounded disabled:opacity-50" disabled>Create Channel</button>
</form>

  </div>  <script>
    // Authentication, state, and database logic
    let currentUser, currentChannel = null, imageFile = null, isEditing = false;
    const db = firebase.database(), storage = firebase.storage(), auth = firebase.auth();

    const elements = {
      openFormBtn: document.getElementById("openFormBtn"),
      channelForm: document.getElementById("channelForm"),
      channelNameInput: document.getElementById("channelName"),
      channelIdInput: document.getElementById("channelId"),
      userEmailInput: document.getElementById("userEmail"),
      userIdInput: document.getElementById("userId"),
      profileImageInput: document.getElementById("profileImage"),
      previewImage: document.getElementById("previewImage"),
      submitBtn: document.getElementById("submitBtn"),
      nameError: document.getElementById("nameError"),
      idStatus: document.getElementById("idStatus"),
      idSuggestions: document.getElementById("idSuggestions"),
      channelDetails: document.getElementById("channelDetails"),
      existingProfile: document.getElementById("existingProfile"),
      existingChannelName: document.getElementById("existingChannelName"),
      existingChannelId: document.getElementById("existingChannelId"),
      existingEmail: document.getElementById("existingEmail"),
      existingCreatedAt: document.getElementById("existingCreatedAt"),
      editBtn: document.getElementById("editBtn"),
      deleteBtn: document.getElementById("deleteBtn")
    };

    function slugify(str) {
      return str.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
    }

    async function isIdAvailable(id) {
      const snap = await db.ref('channels/' + id).get();
      return !snap.exists();
    }

    function showSuggestions(base) {
      elements.idSuggestions.innerHTML = Array.from({length: 3}, (_, i) => `<button type="button" class="text-blue-600 underline mr-2" onclick="document.getElementById('channelId').value='${base}${i+1}'; validateForm();">${base}${i+1}</button>`).join(' ');
    }

    async function validateForm() {
      const name = elements.channelNameInput.value.trim();
      const id = elements.channelIdInput.value.trim();
      if (!name) {
        elements.nameError.classList.remove('hidden');
        elements.submitBtn.disabled = true;
        return;
      }
      elements.nameError.classList.add('hidden');

      if (!id) {
        elements.idStatus.textContent = 'Channel ID required';
        elements.idStatus.classList.remove('hidden');
        elements.submitBtn.disabled = true;
        return;
      }

      const available = await isIdAvailable(id);
      if (!available && (!isEditing || id !== currentChannel.channelId)) {
        elements.idStatus.classList.remove('hidden');
        showSuggestions(slugify(name));
        elements.submitBtn.disabled = true;
        return;
      }

      elements.idStatus.classList.add('hidden');
      elements.idSuggestions.innerHTML = '';
      elements.submitBtn.disabled = false;
    }

    elements.profileImageInput.addEventListener("change", e => {
      imageFile = e.target.files[0];
      if (imageFile) {
        const reader = new FileReader();
        reader.onload = e => {
          elements.previewImage.src = e.target.result;
          elements.previewImage.classList.remove("hidden");
        };
        reader.readAsDataURL(imageFile);
      }
    });

    elements.channelNameInput.addEventListener("input", () => {
      if (!isEditing) elements.channelIdInput.value = slugify(elements.channelNameInput.value);
      validateForm();
    });
    elements.channelIdInput.addEventListener("input", validateForm);

    elements.channelForm.addEventListener("submit", async e => {
      e.preventDefault();
      if (!confirm(isEditing ? 'Save changes?' : 'Create channel?')) return;

      const id = elements.channelIdInput.value;
      const data = {
        channelName: elements.channelNameInput.value,
        channelId: id,
        email: elements.userEmailInput.value,
        userId: elements.userIdInput.value,
        createdAt: isEditing ? currentChannel.createdAt : new Date().toISOString()
      };

      if (imageFile) {
        const snap = await storage.ref(`channelImages/${id}.jpg`).put(imageFile);
        data.profileImageUrl = await snap.ref.getDownloadURL();
      } else if (isEditing) {
        data.profileImageUrl = currentChannel.profileImageUrl;
      }

      await db.ref('channels/' + id).set(data);
      alert('Channel saved.');
      location.reload();
    });

    elements.openFormBtn.addEventListener("click", () => {
      elements.openFormBtn.classList.add("hidden");
      elements.channelForm.classList.remove("hidden");
    });

    auth.onAuthStateChanged(async user => {
      if (!user) return location.href = '/login.html';
      currentUser = user;
      elements.userEmailInput.value = user.email;
      elements.userIdInput.value = user.uid;

      const snap = await db.ref('channels').orderByChild('userId').equalTo(user.uid).get();
      if (snap.exists()) {
        snap.forEach(s => currentChannel = s.val());
        const c = currentChannel;
        elements.existingProfile.src = c.profileImageUrl || '';
        elements.existingChannelName.textContent = c.channelName;
        elements.existingChannelId.textContent = `ID: ${c.channelId}`;
        elements.existingEmail.textContent = c.email;
        elements.existingCreatedAt.textContent = `Created: ${new Date(c.createdAt).toLocaleString()}`;
        elements.channelDetails.classList.remove("hidden");
      }
    });

    elements.editBtn?.addEventListener("click", () => {
      isEditing = true;
      elements.channelForm.classList.remove("hidden");
      elements.openFormBtn.classList.add("hidden");
      elements.channelDetails.classList.add("hidden");
      const c = currentChannel;
      elements.channelNameInput.value = c.channelName;
      elements.channelIdInput.value = c.channelId;
      elements.previewImage.src = c.profileImageUrl;
      if (c.profileImageUrl) elements.previewImage.classList.remove("hidden");
      validateForm();
    });

    elements.deleteBtn?.addEventListener("click", async () => {
      if (!confirm("Delete channel?")) return;
      const id = currentChannel.channelId;
      await db.ref('channels/' + id).remove();
      if (currentChannel.profileImageUrl) {
        await storage.ref(`channelImages/${id}.jpg`).delete().catch(() => {});
      }
      alert("Channel deleted.");
      location.reload();
    });
  </script></body>
</html>
