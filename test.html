<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Firebase Upload and Retrieve</title>
  <style>
    body { font-family: sans-serif; max-width: 700px; margin: auto; padding: 20px; }
    input, textarea { width: 100%; margin-bottom: 10px; padding: 8px; }
    .post { border: 1px solid #ccc; padding: 10px; margin-top: 20px; }
    video, img { max-width: 100%; height: auto; }
    .timestamp { font-size: 0.9em; color: gray; }
  </style>
  <script src="firebase-config.js"></script>
</head>
<body>

<h2>Upload Image or Video</h2>

<form id="uploadForm">
  <input type="text" id="title" placeholder="Title" required />
  <textarea id="description" placeholder="Description" rows="3" required></textarea>
  <input type="file" id="fileInput" accept="image/*,video/*" required />
  <button type="submit">Upload</button>
</form>

<h2>All Posts</h2>
<div id="posts"></div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

<script>
  // Replace this config with your Firebase project settings
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    databaseURL: "YOUR_DATABASE_URL",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MSG_ID",
    appId: "YOUR_APP_ID"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  const storage = firebase.storage();

  // Sign in anonymously (for testing)
  auth.signInAnonymously().catch(console.error);

  const form = document.getElementById('uploadForm');
  const postsDiv = document.getElementById('posts');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const title = document.getElementById('title').value.trim();
    const description = document.getElementById('description').value.trim();
    const file = document.getElementById('fileInput').files[0];

    if (!file || !title || !description) {
      alert('Fill all fields and select a file');
      return;
    }

    try {
      const uid = auth.currentUser.uid;
      const ext = file.name.split('.').pop();
      const path = `uploads/${uid}_${Date.now()}.${ext}`;
      const ref = storage.ref(path);
      const snapshot = await ref.put(file);
      const url = await snapshot.ref.getDownloadURL();

      await db.ref('media').push({
        uid,
        title,
        description,
        mediaUrl: url,
        mediaType: file.type.startsWith('video') ? 'video' : 'image',
        timestamp: Date.now()
      });

      form.reset();
      alert("Upload successful!");
    } catch (err) {
      alert("Error: " + err.message);
    }
  });

  function formatTime(ts) {
    return new Date(ts).toLocaleString();
  }

  db.ref('media').on('value', snapshot => {
    postsDiv.innerHTML = '';
    const data = snapshot.val();
    if (!data) {
      postsDiv.innerHTML = "<p>No posts yet</p>";
      return;
    }

    Object.values(data).reverse().forEach(post => {
      const div = document.createElement('div');
      div.className = "post";
      div.innerHTML = `
        <h3>${post.title}</h3>
        <p>${post.description}</p>
        ${post.mediaType === 'video'
          ? `<video controls src="${post.mediaUrl}"></video>`
          : `<img src="${post.mediaUrl}" alt="media">`
        }
        <p class="timestamp">Posted: ${formatTime(post.timestamp)}</p>
      `;
      postsDiv.appendChild(div);
    });
  });
</script>

</body>
  </html>
