<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>User Content Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Smooth fade for toggle content */
    .fade-enter {
      opacity: 0;
      transform: translateX(20px);
    }
    .fade-enter-active {
      opacity: 1;
      transform: translateX(0);
      transition: opacity 300ms, transform 300ms;
    }
    .fade-exit {
      opacity: 1;
      transform: translateX(0);
    }
    .fade-exit-active {
      opacity: 0;
      transform: translateX(-20px);
      transition: opacity 300ms, transform 300ms;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">

  <!-- Login Section -->
  <div id="loginContainer" class="max-w-md w-full bg-white rounded-md shadow-md p-6">
    <h2 class="text-2xl font-semibold mb-4 text-center">Login</h2>
    <button id="loginBtn" class="w-full bg-pink-600 text-white py-2 rounded hover:bg-pink-700 transition">Login with Google</button>
  </div>

  <!-- Main Content Section (hidden until login) -->
  <div id="mainContainer" class="hidden max-w-7xl w-full mt-6 bg-white rounded-md shadow-md p-4 flex flex-col">

    <!-- User ID (hidden) -->
    <input type="hidden" id="userIdInput" />

    <!-- Toggle Buttons -->
    <div class="flex justify-center space-x-4 mb-6">
      <button data-tab="posts" class="tabBtn bg-pink-500 text-white px-4 py-2 rounded shadow hover:bg-pink-600 transition">Posts</button>
      <button data-tab="videos" class="tabBtn bg-gray-300 text-gray-700 px-4 py-2 rounded shadow hover:bg-pink-100 transition">Videos</button>
      <button data-tab="shorts" class="tabBtn bg-gray-300 text-gray-700 px-4 py-2 rounded shadow hover:bg-pink-100 transition">Shorts</button>
    </div>

    <!-- Sections Container -->
    <div class="flex flex-row space-x-6 justify-center w-full max-w-full overflow-x-auto">

      <!-- Posts Section -->
      <div id="postsSection" class="tabSection flex flex-wrap gap-4 justify-center max-w-full" style="min-width: 300px;">
        <!-- Posts (Images) will appear here -->
      </div>

      <!-- Videos Section -->
      <div id="videosSection" class="tabSection hidden max-w-full justify-center" style="min-width: 640px;">
        <!-- Videos (Landscape) appear here -->
      </div>

      <!-- Shorts Section -->
      <div id="shortsSection" class="tabSection hidden max-w-full justify-center" style="min-width: 360px;">
        <!-- Shorts (Vertical Videos) appear here -->
      </div>

    </div>
  </div>

  <script>
    

       const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();

    // Elements
    const loginContainer = document.getElementById("loginContainer");
    const mainContainer = document.getElementById("mainContainer");
    const userIdInput = document.getElementById("userIdInput");

    const postsSection = document.getElementById("postsSection");
    const videosSection = document.getElementById("videosSection");
    const shortsSection = document.getElementById("shortsSection");

    const tabButtons = document.querySelectorAll(".tabBtn");
    const tabSections = document.querySelectorAll(".tabSection");

    // Toggle tabs function
    function switchTab(tabName) {
      tabSections.forEach(sec => {
        sec.classList.add("hidden");
        if (sec.id === tabName + "Section") {
          sec.classList.remove("hidden");
        }
      });
      tabButtons.forEach(btn => {
        btn.classList.remove("bg-pink-500", "text-white");
        btn.classList.add("bg-gray-300", "text-gray-700");
        if (btn.dataset.tab === tabName) {
          btn.classList.add("bg-pink-500", "text-white");
          btn.classList.remove("bg-gray-300", "text-gray-700");
        }
      });
    }

    // Setup tab buttons event
    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        switchTab(btn.dataset.tab);
      });
    });

    // Start on posts tab
    switchTab("posts");

    // Create post card (image)
    function createPostCard(post) {
      const card = document.createElement("div");
      card.className = "bg-white rounded-md shadow-md overflow-hidden max-w-xs";
      if (post.type === "image") {
        card.innerHTML = `
          <img src="${post.url}" alt="${post.title || 'Image Post'}" class="w-full h-48 object-cover" loading="lazy" />
          <div class="p-2 text-center font-semibold text-gray-700">${post.title || "Untitled"}</div>
        `;
      }
      return card;
    }

    // Create video card (landscape)
    function createVideoCard(post) {
      const card = document.createElement("div");
      card.className = "bg-black rounded-md shadow-md overflow-hidden max-w-md";
      card.innerHTML = `
        <video controls class="w-full h-56 object-cover" preload="metadata" playsinline>
          <source src="${post.url}" type="video/mp4" />
          Sorry, your browser does not support the video tag.
        </video>
        <div class="p-2 text-center text-white font-semibold bg-gray-800">${post.title || "Untitled Video"}</div>
      `;
      return card;
    }

    // Create short card (vertical video)
    function createShortCard(post) {
      const card = document.createElement("div");
      card.className = "bg-black rounded-md shadow-md overflow-hidden max-w-xs";
      card.innerHTML = `
        <video controls class="w-40 h-80 object-cover" preload="metadata" playsinline>
          <source src="${post.url}" type="video/mp4" />
          Sorry, your browser does not support the video tag.
        </video>
        <div class="p-2 text-center text-white font-semibold bg-gray-800">${post.title || "Untitled Short"}</div>
      `;
      return card;
    }

    // Fetch video metadata (width and height) from Firebase Storage
    async function getVideoMetadata(storagePath) {
      try {
        const videoRef = storage.refFromURL(storagePath);
        const metadata = await videoRef.getMetadata();
        return { width: metadata.customMetadata?.width || 0, height: metadata.customMetadata?.height || 0 };
      } catch (error) {
        console.error("Error fetching metadata for video:", error);
        return { width: 0, height: 0 };
      }
    }

    // Load posts/videos/shorts for user
    async function loadPosts(userId) {
      const userRef = db.ref(`uploads/${userId}`);
      userRef.off(); // remove previous listener if any
      userRef.on("value", async snapshot => {
        postsSection.innerHTML = "";
        videosSection.innerHTML = "";
        shortsSection.innerHTML = "";

        const promises = [];

        snapshot.forEach(childSnapshot => {
          const post = childSnapshot.val();

          // If image - push directly
          if (post.type === "image") {
            const card = createPostCard(post);
            postsSection.appendChild(card);
          }
          // If video - fetch metadata and categorize
          else if (post.type === "video") {
            // Fetch metadata promise
            const p = (async () => {
              // Assume post.url is Firebase Storage URL
              // To get metadata, we must ensure metadata includes width & height stored in customMetadata
              // If not available, treat as landscape by default

              // Firebase storage URL can be in form 'gs://...' or https URL
              // If https URL, replace with gs:// equivalent if needed (depends on your storage structure)
              // Here assuming you store https download URLs - so we cannot get metadata from storage ref directly
              // So, store metadata in your db as customMetadata or else skip dimension check

              // For demo, let's assume you store width and height in post metadata (post.width, post.height)
              // If missing, default to landscape

              const width = post.width || 1280;
              const height = post.height || 720;

              if (height > width) {
                // Vertical video = short
                const shortCard = createShortCard(post);
                shortsSection.appendChild(shortCard);
              } else {
                // Landscape video
                const videoCard = createVideoCard(post);
                videosSection.appendChild(videoCard);
              }
            })();
            promises.push(p);
          }
        });

        await Promise.all(promises);
      });
    }

    // Login button handler
    document.getElementById("loginBtn").onclick = async () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      try {
        await auth.signInWithPopup(provider);
      } catch (err) {
        alert("Login failed: " + err.message);
      }
    };

    // Monitor auth state and load user data
    auth.onAuthStateChanged(user => {
      if (user) {
        loginContainer.classList.add("hidden");
        mainContainer.classList.remove("hidden");
        userIdInput.value = user.uid;
        loadPosts(user.uid);
      } else {
        loginContainer.classList.remove("hidden");
        mainContainer.classList.add("hidden");
      }
    });
  </script>

</body>
</html>
